{% extends "payments/base.html" %}
{% load payments_tags %}
{% load base_filters %}
{% load styled_forms %}

{% block extra_head %}
{{ block.super }}
<script type="text/javascript" src="{{ payment_form_url}}"></script>

<script type="application/javascript">
    window.squareInfo = {
      applicationId: '{{ SQUARE_APPLICATION_ID }}',
      locationId: '{{ SQUARE_LOCATION_ID }}',
      payment_id: '{{ payment.pk }}',
      guid: '{{ payment.guid }}'
    };
</script>

{% endblock %}

{% block content %}

<div class="well basic-info">
  <div>{% trans 'Invoice #' %}: {{ payment.invoice.id }}</div>
  <div>{% trans 'Description' %}: {{ payment.description }}</div>
  <div id="total-amount">{% trans 'Total' %}: {{ payment.amount|format_currency }}</div>
</div>

<div class="forms">

{% if billing_info_form.errors.values %}
    <div class="errors">
        <ul>
            {{ billing_info_form.non_field_errors }}
            {% for field in billing_info_form %}
                {% if field.errors %}
                    {% for error in field.errors %}
                    <li>{{ field.label_tag }}  &ndash; {{ error }}</li>
                    {% endfor %}
                {% endif %}
            {% endfor %}

        </ul>
    </div>
{% endif %}


<p>{% trans 'Please fill out the fields below' %}</p>




<form action="" method="POST" id="payment-form" class="form-horizontal">{% csrf_token %}
  <h3>{% trans 'Payment Information' %}</h3>
    <div class="form-group">
        <label for="card-element" class="col-sm-3 control-label">
          Credit or debit card:
        </label>
        <div id="card-element" class="col-sm-9">
          <!-- a Square Element will be inserted here. -->
        </div>
        <br />
        <div id="card-errors"  class="col-sm-offset-3 col-sm-9" role="alert"></div>
    </div>


    <div class="form-group">
        <label for="id_card_name" class="required col-sm-3  control-label">{% trans 'Name on Card' %}:</label>
        <div class="col-sm-9">
        <input class="card-name form-control" id="id_card_name" maxlength="100" type="text">
        <span class="error text-danger">{{ form.card_name.errors }}</span>
        </div>
    </div>


    <h3>Billing Information</h3>
    {% for field in billing_info_form %}
     <div class="form-group">
        <label for="id_{{ field.name }}" class="{% if field.field.required %}required {% endif %}col-sm-3 control-label">{{ field.label }}:</label>
        <div class="col-sm-{% if field.field.width %}{{ field.field.width }}{% else %}9{% endif %}">
          {{ field }}
          <span class="error text-danger">{{ field.errors }}</span>
        </div>

    </div>

    {% endfor %}

    <div class="col-sm-offset-3 col-sm-9">
    <button id='card-submit' type="submit" class="submit-button btn btn-primary">{% trans 'Submit Payment' %}</button>
     </div>

    <div class="col-sm-offset-3 col-sm-9" id="submit-loader" style="font-style:italic; font-size:0.9em; margin-top: 1em; display:none;">
      <img src="{% static 'images/ajax-loader.gif' %}" alt="{% trans 'loading' %}" title="{% trans 'loading' %}"/> {% trans 'loading...' %}
    </div>
</form>
</div>

<p>&nbsp;</p>
{% endblock %}

{% block extra_body %}
    {{ block.super }}

<script type="text/javascript">
  function squareTokenHandler(token) {
		  // Insert the token ID into the form so it gets submitted to the server
		  var form = document.getElementById('payment-form');
		  var hiddenInput = document.createElement('input');
		  hiddenInput.setAttribute('type', 'hidden');
		  hiddenInput.setAttribute('name', 'square_token');
		  hiddenInput.setAttribute('value', token);
		  form.appendChild(hiddenInput);
	
		  // Submit the form
		  form.submit();
	}

  function squarePaymentTest(token) {

   $.post( '/payments/square/card/charge/', {
      payment_id: squareInfo.payment_id,
      guid: squareInfo.guid,
      square_token: token,
      amount_money: 1000
   } )
    .done(function( data ) {
        console.log(data);
    });
 }

  async function CardPay(fieldEl, buttonEl) {
    // Create a card payment object and attach to page
    const card = await window.payments.card({
      style: {
        '.input-container.is-focus': {
          borderColor: '#006AFF'
        },
        '.message-text.is-error': {
          color: '#BF0020'
        }
      }
    });
    await card.attach(fieldEl);

    async function eventHandler(event) {
      event.preventDefault();
      // Clear any existing messages
      window.paymentFlowMessageEl.innerText = '';

      try {
        buttonEl.disabled = true;
        $('#submit-loader').show();
        const result = await card.tokenize();
        if (result.status === 'OK') {
          // appends to form and submits
          squarePaymentTest(result.token);
        }
      } catch (e) {
        buttonEl.disabled = false;
        $('#submit-loader').hide();
        
        if (e.message) {
          window.showError(`Error: ${e.message}`);
        } else {
          window.showError('Something went wrong');
        }
      }
    }

    buttonEl.addEventListener('click', eventHandler);
  }

  async function SquarePaymentFlow() {
    // Create card payment object and attach to page
    CardPay(document.getElementById('card-element'), document.getElementById('card-submit'));
  }

  window.payments = Square.payments(squareInfo.applicationId, squareInfo.locationId);

  window.paymentFlowMessageEl = document.getElementById('card-errors');

  window.showSuccess = function(message) {
    window.paymentFlowMessageEl.classList.add('success');
    window.paymentFlowMessageEl.classList.remove('error');
    window.paymentFlowMessageEl.innerText = message;
  }

  window.showError = function(message) {
    window.paymentFlowMessageEl.classList.add('error');
    window.paymentFlowMessageEl.classList.remove('success');
    window.paymentFlowMessageEl.innerText = message;
  }

  $.ajaxSetup({
      data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
  });

  SquarePaymentFlow();
</script>
{% endblock %}
